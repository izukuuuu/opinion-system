# Filter 模块调用说明

本文档简要介绍 `backend/src/filter` 目录下关键组件的作用及使用方式。

## 模块概览

- `__init__.py`
  - 暴露 `run_filter` 接口，方便其它模块通过 `from backend.src.filter import run_filter` 直接调用同步筛选功能。
- `data_filter.py`
  - 实现基于大模型的文本相关性筛选流程，提供异步主流程 `run_filter_async` 以及同步封装 `run_filter`。
  - 主要职责包括：
    - 读取筛选提示词模板、清洗后的 JSONL 数据。
    - 对文本做截断（`_truncate`）和提示词填充。
    - 通过 `QwenClient` 调用模型接口，结合 QPS 与重试策略（`call_with_qps` 内部协程）。
    - 解析模型返回（`_parse_response`、`_is_high`、`_get_classification`），过滤出高相关内容并写回 JSONL。
    - 统计日志信息（调用次数、耗时 Token、相关条目数量等）。

## 使用示例

```python
from backend.src.filter import run_filter

# 以“example_topic”专题、日期“2024-05-20”为例
success = run_filter(topic="example_topic", date="2024-05-20")
if not success:
    raise RuntimeError("筛选失败，请检查日志输出或提示词配置")
```

> **提示**：
> - 筛选依赖 `configs/prompt/filter/<topic>.yaml` 提供的提示词模板；
> - 输入数据应位于 `bucket("clean", topic, date)` 目录下（由清洗流程产出的 JSONL 文件）；
> - 运行前请确保已经正确配置 Qwen API Key 及相关设置。
