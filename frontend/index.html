<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Opinion System API 测试台</title>
    <style>
      :root {
        font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
        background: #f4f6fb;
        color: #1f2933;
      }

      body {
        margin: 0;
        padding: 2rem;
        line-height: 1.6;
      }

      h1 {
        margin-bottom: 1rem;
      }

      section {
        background: #ffffff;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      }

      form {
        display: grid;
        gap: 0.75rem;
      }

      label {
        font-weight: 600;
      }

      input,
      button,
      select {
        padding: 0.6rem 0.75rem;
        font-size: 1rem;
        border-radius: 8px;
        border: 1px solid #d3dce6;
      }

      button {
        background: #2563eb;
        color: #ffffff;
        border: none;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      button:hover {
        background: #1d4ed8;
      }

      pre {
        background: #0f172a;
        color: #f8fafc;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
      }

      .two-column {
        display: grid;
        gap: 1rem;
      }

      @media (min-width: 900px) {
        .two-column {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <h1>Opinion System API 测试台</h1>
    <p>
      此页面用于验证前后端通信。请先启动 <code>backend/server.py</code> 对应的 Flask 服务，确保配置中的端口号一致。
    </p>

    <section>
      <h2>服务状态</h2>
      <button id="statusBtn">检查后端状态</button>
      <pre id="statusResult">等待调用...</pre>
    </section>

    <section class="two-column">
      <div>
        <h2>数据合并 / 清洗 / 筛选 / 上传</h2>
        <form id="pipelineForm">
          <label>
            专题 Topic
            <input type="text" name="topic" placeholder="例如：示例专题" required />
          </label>
          <label>
            日期 Date (YYYY-MM-DD)
            <input type="text" name="date" placeholder="2024-01-01" required />
          </label>
          <label>
            操作 Operation
            <select name="operation" required>
              <option value="merge">Merge</option>
              <option value="clean">Clean</option>
              <option value="filter">Filter</option>
              <option value="upload">Upload</option>
            </select>
          </label>
          <button type="submit">执行操作</button>
        </form>
        <pre id="pipelineResult">等待调用...</pre>
      </div>

      <div>
        <h2>数据库操作</h2>
        <button id="queryBtn">查询 Query</button>
        <pre id="queryResult">等待调用...</pre>
      </div>
    </section>

    <section class="two-column">
      <div>
        <h2>数据提取 Fetch</h2>
        <form id="fetchForm">
          <label>
            专题 Topic
            <input type="text" name="topic" placeholder="例如：示例专题" required />
          </label>
          <label>
            开始日期 Start (YYYY-MM-DD)
            <input type="text" name="start" placeholder="2024-01-01" required />
          </label>
          <label>
            结束日期 End (YYYY-MM-DD)
            <input type="text" name="end" placeholder="2024-01-07" required />
          </label>
          <button type="submit">提取数据</button>
        </form>
        <pre id="fetchResult">等待调用...</pre>
      </div>

      <div>
        <h2>数据分析 Analyze</h2>
        <form id="analyzeForm">
          <label>
            专题 Topic
            <input type="text" name="topic" placeholder="例如：示例专题" required />
          </label>
          <label>
            开始日期 Start (YYYY-MM-DD)
            <input type="text" name="start" placeholder="2024-01-01" required />
          </label>
          <label>
            结束日期 End (YYYY-MM-DD)
            <input type="text" name="end" placeholder="2024-01-07" required />
          </label>
          <label>
            (可选) 指定函数 Function
            <input type="text" name="function" placeholder="函数名称" />
          </label>
          <button type="submit">运行分析</button>
        </form>
        <pre id="analyzeResult">等待调用...</pre>
      </div>
    </section>

    <script>
      const state = {
        backendBase: "http://127.0.0.1:8000",
        configLoaded: false,
      };

      const prettyPrint = (elementId, data) => {
        document.getElementById(elementId).textContent = JSON.stringify(data, null, 2);
      };

      const handleError = (elementId, error) => {
        prettyPrint(elementId, {
          status: "error",
          message: error.message || error,
        });
      };

      async function ensureConfig() {
        if (state.configLoaded) {
          return;
        }
        try {
          const response = await fetch(`${state.backendBase}/api/config`);
          if (!response.ok) throw new Error(`配置获取失败: ${response.status}`);
          const config = await response.json();
          if (config.backend && config.backend.base_url) {
            state.backendBase = config.backend.base_url;
          } else if (config.backend && config.backend.host && config.backend.port) {
            state.backendBase = `http://${config.backend.host}:${config.backend.port}`;
          }
          state.configLoaded = true;
        } catch (error) {
          console.warn("加载配置失败，使用默认后端地址", error);
          state.configLoaded = true;
        }
      }

      async function callApi(path, options = {}) {
        await ensureConfig();
        const response = await fetch(`${state.backendBase}${path}`, {
          headers: {
            "Content-Type": "application/json",
          },
          ...options,
        });
        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || `请求失败: ${response.status}`);
        }
        return response.json();
      }

      document.getElementById("statusBtn").addEventListener("click", async () => {
        try {
          const data = await callApi("/api/status", { method: "GET" });
          prettyPrint("statusResult", data);
        } catch (error) {
          handleError("statusResult", error);
        }
      });

      document.getElementById("queryBtn").addEventListener("click", async () => {
        try {
          const data = await callApi("/api/query", { method: "POST", body: JSON.stringify({}) });
          prettyPrint("queryResult", data);
        } catch (error) {
          handleError("queryResult", error);
        }
      });

      document.getElementById("pipelineForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(event.target);
        const payload = Object.fromEntries(formData.entries());
        try {
          const data = await callApi(`/api/${payload.operation}`, {
            method: "POST",
            body: JSON.stringify({ topic: payload.topic, date: payload.date }),
          });
          prettyPrint("pipelineResult", data);
        } catch (error) {
          handleError("pipelineResult", error);
        }
      });

      document.getElementById("fetchForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(event.target);
        const payload = Object.fromEntries(formData.entries());
        try {
          const data = await callApi("/api/fetch", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          prettyPrint("fetchResult", data);
        } catch (error) {
          handleError("fetchResult", error);
        }
      });

      document.getElementById("analyzeForm").addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(event.target);
        const payload = Object.fromEntries(formData.entries());
        if (!payload.function) {
          delete payload.function;
        }
        try {
          const data = await callApi("/api/analyze", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          prettyPrint("analyzeResult", data);
        } catch (error) {
          handleError("analyzeResult", error);
        }
      });

      // 自动触发一次状态检查
      document.getElementById("statusBtn").click();
    </script>
  </body>
</html>
